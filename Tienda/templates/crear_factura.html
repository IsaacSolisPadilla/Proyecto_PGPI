<h1>Crear pedido</h1>
<style>
    /* Estilo general */
    body {
        font-family: 'Arial', sans-serif;
        background: linear-gradient(135deg, #f0f3f5, #d9e2ec);
        color: #333;
        margin: 0;
        padding: 20px;
    }

    /* Encabezado */
    h1 {
        text-align: center;
        font-size: 2.5em;
        color: #1a73e8;
        margin-bottom: 20px;
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.2);
    }

    /* Formulario de usuario */
    .formulario {
        display: flex;
        flex-direction: column;
        background: #fff;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
    }

    .formulario input {
        width: 100%;
        padding: 10px;
        margin: 8px 0;
        border: 1px solid #ccc;
        border-radius: 4px;
        transition: border-color 0.3s;
    }

    .formulario input:focus {
        border-color: #1a73e8;
    }

    /* Tabla */
    table.cart {
        width: 100%;
        border-collapse: collapse;
        overflow: hidden;
        border-radius: 8px;
        background-color: #ffffff;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    thead {
        background-color: #1a73e8;
        color: #ffffff;
    }

    thead th {
        padding: 15px;
        font-weight: bold;
        font-size: 1em;
    }

    tbody tr {
        transition: background-color 0.3s;
    }

    tbody tr:hover {
        background-color: #f1f5f9;
    }

    /* Celdas */
    td {
        padding: 15px;
        text-align: center;
        font-size: 0.9em;
        color: #333;
    }

    td img {
        max-width: 60px;
        max-height: 60px;
        border-radius: 5px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    /* Botón de remover */
    td button {
        width: 40px;
        padding: 10px 15px;
        background-color: #ff4c4c;
        color: #fff;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.3s ease;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.15);
    }


    td button:hover {
        background-color: #e62e2e;
    }

    /* Precio */
    td:last-child,
    td:nth-last-child(2) {
        font-weight: bold;
        color: #555;
    }

    /* Botón Aceptar */
    button {
        display: block;
        width: 100%;
        max-width: 200px;
        margin: 20px auto;
        padding: 12px 0;
        font-size: 1em;
        color: #fff;
        background-color: #1a73e8;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.3s;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }

    button:hover {
        background-color: #155bb5;
    }

    .icon {
        color: #1a73e8;
    }

    .icon:hover {
        color: #155bb5;
    }

    input[type="number"] {
        font-size: 18px;
        padding: 12px;
        width: 100px;
        border: 2px solid #ddd;
        border-radius: 8px;
        outline: none;
        background-color: #fafafa;
        transition: border-color 0.3s, box-shadow 0.3s;
    }

    input[type="number"]:focus {
        border-color: #4caf50;
        box-shadow: 0 0 10px rgba(76, 175, 80, 0.2);
    }

    input[type="number"]:hover {
        border-color: #888;
    }

    /* Ocultar las flechitas en los campos de tipo number */
    input[type="number"]::-webkit-outer-spin-button,
    input[type="number"]::-webkit-inner-spin-button {
        -webkit-appearance: none;
        margin: 0;
    }

    /* Estilo de la tabla en dispositivos móviles */
    @media (max-width: 768px) {
        .formulario input {
            width: 80%;
        }

        table,
        thead tr,
        tbody tr {
            display: block;
            width: 100%;
        }

        thead {
            display: none;
        }

        tbody tr {
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
        }

        tbody td {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            text-align: left;
            font-size: 0.85em;
        }

        tbody td:before {
            content: attr(data-label);
            font-weight: bold;
            color: #333;
        }
    }
</style>

<table class="cart">

    <div class="formulario">
        <div style="display: flex; flex-direction: row; justify-content: space-between;">
            <p style="width: 60vh;">Nombre:<input id="nombre" type="text"></p>
            <p style="width: 60vh;">Apellidos:<input id="apellidos" type="text"></p>
            <p style="width: 60vh;">Email:<input id="email" type="email"></p>
        </div>

        <p>Direccion:<input id="direccion" type="text"></p>
    </div>

    <thead>
        <tr>
            <th>Imagen</th>
            <th>Producto</th>
            <th>Cantidad</th>
            <th>Remover</th>
            <th>Precio Unitario</th>
            <th>Precio total</th>
        </tr>
    </thead>
    <tbody id="lineas">
        <!-- Se rellena en el javascript -->
    </tbody>
    
</table>
<div style="display: flex; flex-direction: row;">
    <button onclick="crearFactura()">Aceptar</button>
    <button onclick="window.location.href = '/' ">Volver</button>    
</div>

<script src="https://unpkg.com/feather-icons"></script>
<script>
    feather.replace();
    var factura = null;
    fetch("/factura")
        .then(data => data.json())
        .then(json => factura = json)
        .then(_ => {
            const tbody = document.getElementById("lineas")
            console.log(factura)
            for(const n_linea in factura) {
                tbody.innerHTML += `
                <tr id="linea-${n_linea}">
                    <td>
                        <img src="${factura[n_linea].producto.fotografia}" alt="${factura[n_linea].producto.nombre}">
                    </td>
                    <td>
                        ${factura[n_linea].producto.nombre}
                    </td>
                    <td>
                        <input id="cantidad-${n_linea}"
                               n_linea="${n_linea}"
                               onkeydown="return soloFlechas(event);" 
                               oninput="actualizarAtributo(this)"
                               value="${factura[n_linea].cantidad}"  
                               type="number" 
                               min="1" 
                               max="${factura[n_linea].producto.stock}">
                    </td>
                    <td>
                        <button n_linea="${n_linea}" onclick="eliminarProducto(this)">
                            X
                        </button>
                    </td>
                    <td>
                        ${factura[n_linea].producto.precio}€
                    </td>
                    <td id="precio_total-${n_linea}">
                        ${factura[n_linea].cantidad * factura[n_linea].producto.precio}€
                    </td>
                </tr>`

            }
            
            tbody.innerHTML += ` 
            <tr>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td>
                    <p style="display: flex; align-items: start;">+</p>
                    <hr>
                    <p id="precio_total">${factura[0].factura.precio_total}€</p>
                </td>
            </tr>`
        })

    function actualizarAtributo(elemento) {
        const n_linea = elemento.getAttribute("n_linea")
        const precio_total_linea = document.getElementById(`precio_total-${n_linea}`)
        precio_total_linea.textContent = (elemento.value * factura[n_linea].producto.precio).toFixed(2) + "€"
        const precio_total = document.getElementById(`precio_total`)
        let valor = 0
        for (const index in factura) {
            valor += Number(document.getElementById(`precio_total-${index}`).textContent.replace("€",""))
        }
        precio_total.textContent = valor.toFixed(2) + "€"
    }

    function eliminarProducto(elemento) {
        const n_linea = elemento.getAttribute("n_linea")
        delete factura[n_linea]
        if(Object.keys(factura).length === 0){
            window.location.href = '/'
        }
        document.getElementById(`linea-${n_linea}`).remove()
        const precio_total = document.getElementById(`precio_total`)
        let valor = 0
        for (const index in factura) {
            valor += Number(document.getElementById(`precio_total-${index}`).textContent.replace("€",""))
        }
        precio_total.textContent = valor.toFixed(2) + "€"
    }

    function soloFlechas(event) {
        if (event.key === 'ArrowUp' || event.key === 'ArrowDown') {
            return true; // Permite las flechas
        }
        event.preventDefault();
    }

    function obtenerForm() {
        const form = {}
        const ids = ["nombre", "apellidos", "email", "direccion"]
        for (const id of ids) {
            form[id] = document.getElementById(id).value
        }
        let lineas_factura = []
        for (const n_linea in factura) {
            lineas_factura.push({
                "producto": factura[n_linea].producto,
                "cantidad": Number(document.getElementById(`cantidad-${n_linea}`).value)
            })
        }
        form["lineas_factura"]=lineas_factura
        return form
    }

    function crearFactura() {
        const form = obtenerForm()
        fetch("/facturas/crear", {
            method: "POST", 
            body: JSON.stringify(form),
            headers: {
                    'X-CSRFToken': '{{csrf_token}}' // Incluir el token CSRF en los encabezados
            }
        }).then(data => console.log(data))
    }
</script>